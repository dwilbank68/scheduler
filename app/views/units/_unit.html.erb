 <!--from units/index.html.erb-->

 <%= div_for unit do %>
    <div class=" container unit">
        <div class="row">
            <div class="col-xs-12 unit-name microgramma-bold txt-centered larger white"><%= unit.screenName %></div>
        </div>

        <div class="spacer"></div>

        <div class="row">
            <div class="col-xs-12"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxASDxIQEBAVEA8UEBQQEBAQEBAQDw8PFRYWFxQUFRQYHCggGBolHBQUITEhJSkrLi4uFx8zODMsNygtLjcBCgoKDAwNFA8PFCwcFBwsKywsLDcsLCwsKywsKywrLCwsLCwsLCwsLCssLCssLCwsLCssKywrKyssLCwsKyssN//AABEIAMIBAwMBIgACEQEDEQH/xAAcAAEAAgMBAQEAAAAAAAAAAAAABAYCAwUBBwj/xABEEAACAQIDBAUIBwYFBQEAAAAAAQIDEQQhMQUSUXEGE0FhgSIyNIKRobLBBxRCUnKx0SMkU2KSohUzwuHwY3OTs9JD/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAAERQTH/2gAMAwEAAhEDEQA/APuIAAAAAAAAAAAAAAAAAAAAAAAAB5vLiB6AAAAAAAAAAAAAAAAAAAAAAAAAAAAA5OI2nLflGCj5LteSbba17TU9o1+EfBP9SJtGC+sTead1mvwrVaPxMqNSS/mXdk/Y8veiokf4lV4r+kfX6v3l/Sj2DhLLR8Hk/Yz14R/Zz7gMfrtX7/uX6Hn1qp99+4PDzWqHUy4AefWKn337Tzrp/fl/UzPqXwHUvgVGG/L7z9rPLvi/abOpZ71LA02PUbHTMcss1m7LPV6gZ08RKOjty09mhKp7Qfak/cROrG4RXVhi4vu56e1G6Mk807ruzOJu95jWq7kZTbfkxcnu+dZDDXeBydkbRdSW7feTpqpFtWdsv1R1iKAAAAAAAAAAAAAAAAAAAAAKztP/AD5818MRSMdrP94nzXwRPKTy8X8jTKZGz1V+5knDZSVm7cG7+95kSLy8TfS1A6GId1rbLssROr72/G35G2T05P5EbEQlKEowluSatGdt7dfG3aFbOpX839c/1MXQjxl/5Kn6lZq9H8ZKTf1uKTd8oN+xPTlc72zsNKlTUJVJVZK7c5ZPN3sl2Jc2Ebd3KUU32NNuTaT7737H2mDiopb3lNO6bed/F/8AMjK/lv8ADH85fqaK9FvO7lnpLciop8GoXA2Qta+6klK67c3e+nbmyJLFuEt2UY285NOMWr3zUXrq8+YljXTVpQk1vJLdTflPLdV0t7wuRY1pVZue7KNOyjGKl5Ts225OM1uvPR3KJeHqR6ySTV35SSacrPN3SWS/Upm39kbeqYuo8LtOjh8K7Sp0pZ1YRUYqd11Tut7e+12oulOm97evbJKzit+1tHO7ueVr3uot+S81u5u97XfNkEfYFGvTw1OniayxFdL9pWirRqXbs0uViRKr5e62reVdXWasmsrd/E1SryV8s7K13FJy7Vr/AM4hSbk893g1JSvkr5dma4ASdlS/erf9OS/JliKxsp/va/BL8izkqwABFAAAAAAAAAAAAAAAAAABVtr+kT5x+CJhTeS5v5GW2fSJ84/BE1wenN/I0ymweS5kim8yLDRcyRTAlp6FGw/RnE1G6lXF14b05S3OtqKybdsr5ci8buWvuv8AM0bluH9NvmFcGHRxfx6j51JfqTdn7Gpwkm5t2fbK50d18fd/uebvf+QRjUa6x7uas1daaq3zPTmY3bMITdGlCWJxC1pwa3ad9HVnpDk832JkWdLF1c62I6mP8LCpKy4OrJXfOKiB2pwT1SyzV7OzPH4PxOB/gOHfnQlWfGtUq1n/AHNnq6P4VaYeMHxhvU37YtAduRqlFPVJ80mcWhQtf6rjJXjdOFSf1qndZWkpPfXhJEmltVxajiaapNtKNaL3sPOTdknJq8JPhLK7STYEh1s3+yeUrLzc195W/LUSrVHdRpO9na7yuk91aaPLkS95mMpPiBq2PJrFU99bspRatm1vbt2k7Z6MtZTsH6bR5v4JFxJVgACKAAAAAAAAAAAAAAAAAACqba9In6vwI1Q0XN/I2bb9Iqep8CNMHkub+RplNg8lzJNLUi03l4kmlqBNjoaWbY6GphXhwMVjamJqzoYaTp0KctzE4qPnOa1o0H95fanpHRZ3tt6Q4qpJ08Hh5OFevfeqqzeGw0bdbVz+1mox/mkuxM6OCwVOjThSpR3acI7sYrsXe+19rfa2RGnA7Pp0oKnSgoQWdl2t6yb1lJ6tvNklUku/mQOke3sPgaDr4iW7FZRis51J9kYrtZ8I6VfSNjsZJxhN4XD9lOlJxm1/PNZt8rLmB95xm1sNTyqV6cO6U4r5miltbD1P8uvCf4ZxZ+ZIwUm5SSlJ6ylrfjkaZOMJb0HaS0s5L3rTwY0x+ldpbJjUkqsfIml5MoZNvtbtrz1I+HxU0+pxCUk04qTV1JcGu3Ls15nyTox9IGMwjhGvJ16DSkqdSW9UUH9qnU1eX2ZZn2GFSjjKEalNqUZK8ZLVP5M1ErPDzdBqDe9h5NRptu7oSfmwb7abyS4Oy0at1GcjAz6yE6VVKUo+RUT0nCWSl45p9/MlbPqOzpzd503uuT1nG14Tfe1r3qQVtwPptLm/hkXAqGA9Mpc38Mi3masAARQAAAAAAAAAAAAAAAAAAVHbj/eanqfAjTB5Lm/kbdu+k1PU+BGiDyXN/I0ynUnl4kmk8yJSeXiSqWoE2GhrZnBnG6U4qdLB4mdP/MVGap/9yStH3tAa+jsesdbGPWvPdpX+zhaTcaaXc3vz9dcDr1asYRlObUYRi5Sb0UUrtswwWFjRo06MfNp04048opRX5FS+lvaLo7LnBO0q040fVzlLwajbxIr4t066UVNoYydVtqhBuFCnpu0+LX3nq/Z2Fe32ZNZcTdhKKdSNOUc5NJJtxzel32EGmlCc3uxTk+COrhsHGlKPk9fiW/JpqLnCEvwrz5c8lwZaqnRivh6XWzjSjQinKpGFWUJuC87y4wk78iPtLbEJKNDY9NUXONqsY039Yk7Z/vNR3kvCJRWNp4CVOT+sSiptOfVbylUT4SUfNb1sWz6IOkUoYmWFk31VXOF/s1Fp7dPFcDiYfo5Jyiq8pUqspJKk42Se9q557117Lm/ZOAVB9an5VOUW2rpTlCVk0vb7hB9m+t0liotSsm+qq3yspZXs9bOz8CbVTjXg9HJSpSX80bzj7LVf6jx2lGMrLNK7ssxjdIS1aqwd223ect15v8bNspGz/TKXN/DIuBT9nemUucvgkXAxWoAAigAAAAAAAAAAAAAAAAAAp23n+81PU+BGiDyXNm7b/pNT1PgRHi8lzNMp1J5eJKpakOk8vEl0nmBNizh9K/R5cOuw6fJ16d/cdmLON0opylhMSoK81SlOC4zh5cffFAdyZ87+mWN6OET8115J30vZWv7z6FTqqcVOOcZRU4vjFq69zKf9K+znV2bKcVeVCca3qq8ZPwUr+BFfneo7N31bb7lnw8CbWxlP61SlRVt2UHdcU8yBtWPluXZJuS7m/OXg/dYi0nbTXQgtXSHpHVxU3HffUp+TBPKcvvSXb3Hc6MYGNBKpJXrvPPPq0+xd/FlQ2NFb2+9IvJcZdns1LNDHqC3pP/dlHZxOPX12Esv2ajJu2fkLffuRXY4nfjufanKMV4u/6ETEY2ym2/2lTJ90Xr+nizqdBdnSxGNpq3kU31k32Zeavbn4BH2amrU4L+VfkZYzSEeNWH9r3/8AQZPOXd8jGq71Yr7kXUfdKXkw93Wew2iRs30yl63wTLeU/ZnptL1vgmXAxWoAAigAAAAAAAAAAAAAAAAAApm3/SqnqfAiNDRcyT0g9Kqep8CIsdFzNMdTaby8SXSeaIdLTxJVJ5oKmxNE/OZugzVNZsCF0anu05YZ+dhpdUlxoPOhJd25aN+MJHUqU4yjKEleMk4yTzTi8mji7ShKnUji6cXJwjuV6cU3Kthr3e6lrOD8qK7fLivOOxQrxqQjOElOEoqUJxd4yi1dNPtRFfnb6Q+is8FXlBxcsNOTlQqd33W+ya96zzztSnTto/kz9bbU2bRxNKVGvTVSnJZxkr8muD7z5L0k+h+ablgqqlHspVrqS7lUWvir94HzHD11FJXWXf2mypjb6Zvi9FyR3an0c7Ui7fVk+9VYW950tmfRbjZtdfOFGHaovrJ/JL3jBT9n4apWqKFOLnOTtFLV974LvPufQ3YEcFh93WtPyqsuMuC7loZ9HOieHwcf2cbzfnVJZzl4/IsEafE1IlrGFopyk7K123oorNtmvCp2c5K0pves9Yx0jHuySuuLZ5KXWSsv8uMvKfZOafmrik9e9W4o3sVHuzPTaPrf+uZcSnbL9Npet/65lxM1qAAIoAAAAAAAAAAAAAAAAAAKZ0g9Kqeo/wC1fqRIaeJL6QelVOUPhiQ4PLxNMdTKWniSqTzRDpPLxRLpPNBU6BrlqzKDMG82AOaqM6EpToR36Mm51cMmk1N5yqUG8k283B2Teaad97oNnjA9wePp1YuVOW9Z2lFpxnTl92cHnB9zSNzkc7FYCnUalKLVRK0asJSp1YrWynFp27tHwMI0sRHzcQpr/r0YylyUqbgvamB0ZJGqUER+ur/dpc9+p+W78zCfXPWpGP8A26flLlKcmv7QNlecIJynJRitZSaSRCk51eyVOlxd41ai4JawXe/K4JZM2wwsFLfd5zWk6jc5Lju3yh6qRtZRjGKSSSSilZJKySWiSPGetmLIMtlem0vW+CRcSm7I9Op8pfBIuRKsAARQAAAAAAAAAAAAAAAAAAUvpA/3upyh8MSFF5eJL6Q+l1OUPhRCjp4mmL6l0nl4r5kui80QqTy8V8yXReYV0Is1y1fMyia5asADw8uB62YthmIBsxYueNgeMxbPWYNgGzE9MWwM9kenU+UvgkXIpew6sZY+KUk2oybSd7eS18y6EqwABFAAAAAAAAAAAAAAAAAABytr7FhW8teRVt53ZK2il+pVatCVOThUi0/l2NPtRfyPjcHCrHdmr8GvOi+KZdSxTILLjmvmSqL7r92Sv7TLG7OnReflQeSlbJ9zXYzGi8yolxrx7bx/FGSXttY0SxtK7/aR9qN3WWRpeI737QMfr1L+JH2j65T+97E2ePFLizGWMXeBk8XDs3nyp1H+SMfrS+5U/wDDUX5oweOXD3mqW0Fw94Rvdd9lOb/oj8TR51k/4dvxTh8rkWW0+XvNL2m+4onfteFNetOX+lHnV1O2ovVp297kznvaEuJi8Y+1v2gT3QX2qk3zko/CkedRSWsVL8V6j/uuRabnLzYSlyi2SaeBxMtKM/GO7+ZBJ2DK+NjbJKMsuC3WXMq/RrZVaNeVWrDcSi4xTavKTazsuzJ+0tBK1AAEUAAAAAAAAAAAAAAAAAAAAAYzimmmrp5NPNM4eP2TKN5UU5L+Hdb3JNu3tO8AKbicNiuzDzfjT/8Aoj/4ZjpaULc6lNf6i9AupikR6P4167kec/0TNsOiuJfnVqa/Dvv5IuQGmRUodDpfaxHsp/PeN8Oh1L7Vab5KK/UswG0yODDolhlq5y5zXyRIp9G8Iv8A8r85zfzOsCauIVPZGGWlCHjBS/Mk08PCPmwjHlFI2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/9k=" alt="unit.screenName" class="unit-image"/></div>
        </div>

        <div class="row">
            <div class="col-xs-7 quicksand-reg            white-glow spaced time-remaining"><%= min_to_hrs_min(unit.duration) %> </div>
            <div class="col-xs-5 quicksand-reg txt-right  white-glow spaced tiny">remaining</div>
        </div>
        <div class="row">
            <div class="col-xs-7 quicksand-reg white-glow est-time-of-completion">
              <% if unit.duration > 0 %>
                <%= unit.time_available.in_time_zone(current_user.timezone).strftime('%b %e, %l:%M %p') if unit.time_available %>
              <% else %>
                Unit Available
              <% end %>
            </div>
            <div class="col-xs-5 quicksand-reg txt-right    white-glow spaced tiny est-time-of-completion-label">est time of completion</div>
        </div>
        <button id="new-user-for-unit-<%= unit.id %>"></button>
    </div> <!-- end unit -->

    <section class="user-queue"><!--user queue-->
        <ul id="unit-user-ul-<%= unit.id %>">
            <% unit.unit_users.each do |unituser| %>
                <%= render :partial => '/unitusers/unit_user', :locals => { user:unituser.user, unit:unit, unituser: unituser }%>
            <% end %>
        </ul>
    </section> <!-- end user queue -->

     <!-- unit user form-->

    <div id="unit_user_form_<%= unit.id %>" class="container unit_user_form microgramma-bold">
        <%= minimal_form_for([unit, @unit_user], :remote => true, html: {class: 'form-vertical'}) do |f| %>
            <%= f.error_notification %>
            <div class="row border-bottom">
              <div class="col-xs-12 larger white-glow-dim spaced7 txt-centered">Schedule <%= unit.screenName %></div>
            </div>
            <div class="row">
              <div class="col-xs-12"></div>
            </div>
            <div class="row border-bottom">
              <div class="col-xs-12 quicksand-reg white-glow"><%= current_user.name %></div>
            </div>
            <div class="row border-bottom">
              <div class="col-xs-8 quicksand-reg white-glow"><%= formatted_phone(current_user.phone) %></div>
              <div class="col-xs-2 quicksand-reg white-glow nfo-visible    green-glow txt-right">visible</div>
              <div class="col-xs-2 quicksand-reg white-glow contact-active green-glow txt-right">active</div>
            </div>
            <div class="row border-bottom">
              <div class="col-xs-8 quicksand-reg white-glow"><%= formatted_phone(current_user.phone2) %></div>
              <div class="col-xs-2 quicksand-reg nfo-visible green-glow txt-right">visible</div>
              <div class="col-xs-2 quicksand-reg contact-active grayed-out txt-right">active</div>
            </div>
            <div class="row border-bottom">
              <div class="col-xs-8 quicksand-reg white-glow"><%= current_user.email %></div>
              <div class="col-xs-2 quicksand-reg nfo-visible green-glow txt-right">visible</div>
              <div class="col-xs-2 quicksand-reg contact-active green-glow txt-right">active</div>
            </div>
            <div class="row">
              <div class="col-xs-8 quicksand-reg white-glow"><%= current_user.email2 %></div>
              <div class="col-xs-2 quicksand-reg nfo-visible green-glow txt-right">visible</div>
              <div class="col-xs-2 quicksand-reg contact-active grayed-out txt-right">active</div>
            </div>
            <div class="spacer"></div>
          <div class="container time-input">
            <div class='row'>
              <div class="col-xs-6 microgramma-bold spaced white-glow-dim">Unit Available</div>
              <div class="col-xs-6 quicksand-reg white-glow start_time txt-right uu-form-start-time">awaiting unit data</div>
            </div>
            <hr/>
            <div class="spacer"></div>
            <div class="row">
              <div class="col-xs-7 microgramma-bold spaced white-glow-dim">Set Duration</div>
              <div class="col-xs-2 txt-right"><%= f.input :duration, :autofocus => true, :input_html => {:min => '0', :max => '1440', :value => 5, :step => '5', :class => 'quicksand-reg white-glow'} %> </div>
              <div class="col-xs-3 quicksand-reg spaced white-glow txt-right">minutes</div>
            </div>
            <div class="spacer"></div>
            <div class="row">
              <div class="col-xs-12 txt-centered">
                <div class="quicksand-reg white-glow formatted-duration slightly-larger txt-centered">0 hrs 0 min</div>
                <div class="col-xs-12 quicksand-reg tiny spaced white-glow-dim txt-centered">selecting 0 will result in a 5 minute minimum being set</div>
              </div>
            </div>
            <div class="spacer"></div>
            <hr/>
            <div class="row">
              <div class="col-xs-7 microgramma-bold white-glow-dim spaced">Projected End Time</div>
              <div class="col-xs-5 quicksand-reg white-glow formatted-end-time txt-right">---</div>
            </div>
          </div>
          <div class="spacer"></div>
          <%= f.input :note, :input_html => { :class => 'quicksand-reg white-glow', :cols => 48 } %>
          <%= f.hidden_field :user_id, :value => @user.id %>
          <%= f.hidden_field :start_time, :value => unit.time_available %>
          <div class="spacer"></div>
          <%= f.error :base %>
          <%= f.button :submit, 'Join Queue', :class => 'white-glow-dim spaced join-queue' %>
        <% end %>
    </div>

<% end %>



<script> // click 'new unituser' button on the unit, you get a modal form, which creates a new unituser in the queue
    $(document).ready(function(){

        //console.log(<%= unit.id %>);
        $('#unit_<%= unit.id %>').draggable();
        $('#unit_<%= unit.id %>').offset({ top:<%= unit.pos_y %>, left:<%= unit.pos_x %> });

        $('#unit_user_form_<%= unit.id %>').hide();

        $('#new-user-for-unit-<%= unit.id %>').on('click', function(){

            var $form = $('#unit_user_form_<%= unit.id %>');

            // detach form from machine unit and reattach it to non-blurring layer, which is z-index 2
            $('#non-blur-layer').append($form);

            // blur the container which holds all the machines ( z-index 0)
            $('#blur-layer').removeClass('blur-out');
            $('#blur-layer').addClass('blur-in');

            // bring in the tinted overlay to prevent click-through
            $('#overlay').fadeIn();

            // bring in the form, at a higher z-index
            $($form).fadeIn().css({top:($(window).height()/2)-107, left:($(window).width()/2)-200, zIndex:3});

            $('#unit_user_duration').focus();

            // AJAX call to server to get unit's time_available field, or Time.now if the field is nil

            var unit_available, unit_available_string;

            $.ajax({
                url: "/units/<%= unit.id %>/report_status",
                type: "GET",
                dataType: "json",
                success: function(data, textStatus, xhr) {
                    unit_available = moment(data['time_available']);
                    unit_available_string = moment(data['time_available']).format('MMM D, hh:mm A');
                    console.log("NEW data is " + JSON.stringify(data));
                    console.log("NEW unit_available is " + unit_available);
                    console.log("NEW unit_available_string is " + unit_available_string);
                    console.log("NEW duration is " + data['duration']);
                    $('.uu-form-start-time').html(unit_available_string);
                },
                error: function() { console.log("ajax error in call to report_status") }
            });

            // zero out the duration field
            $('.numeric:visible').val(0);
            $('.formatted-duration:visible').html('0 hrs 00 min');

            // Set up listener to convert duration (in minutes) into a convenient hrs and minutes string
            // With every input change on the unit_user form, the duration field updates, and the end_time field updates

            var min, dur;

            $('.numeric:visible').on('input', function() {

                // grab the minutes integer from the duration box
                min = $('.numeric:visible').val();

                // create a formatted hrs minutes duration string
                dur = parseInt(min/60) + ' hrs ' + (min % 60) + ' min' ;

                // insert that string into the field below
                $('.formatted-duration:visible').html(dur);

                var startMoment = moment(unit_available);
                console.log('startMoment is ' + startMoment);

                // end time is calculated by adding minutes to the start time
                var endMoment = startMoment.add(min, 'minutes');
                console.log('endMoment is   ' + endMoment);

                // end time is inserted in the appropriate field
                $('.formatted-end-time:visible').html(endMoment.format('MMM D, hh:mm A'));
            });


        });



    });
</script>


