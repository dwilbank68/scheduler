<%= content_tag_for :li, unituser do %>

    <div class="uu-wrapper">
      <div class="container unit-user">

        <div class="row border-bottom">
          <div class="col-xs-12 microgramma-bold larger name spaced"><%= user.name.truncate(12) %>
            <span class="tiny quicksand-reg">(<%= unituser.id %>)</span></div>
        </div>
        <div class="spacer"></div>
        <div class="spacer"></div>
        <div class="row">
          <div class="col-xs-3"><%= image_tag(user.avatar.profile.url, :class => 'img-rounded uu-avatar') if user.avatar? %></div>
          <div class="col-xs-9">
            <div class="container">
              <div class="row">
                <div class="col-xs-10 quicksand-reg email white-glow smaller"><%= user.formatted_email1 %></div>
              </div>
              <div class="row">
                <div class="col-xs-10 quicksand-reg email2 white-glow smaller"><%= user.formatted_email2 %></div>
              </div>
              <div class="row">
                <div class="col-xs-10 quicksand-reg phone white-glow smaller"><%= user.formatted_phone1 %></div>
              </div>
              <div class="row">
                <div class="col-xs-10 quicksand-reg phone2 white-glow smaller"><%= user.formatted_phone2 %></div>
              </div>
            </div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div class="col-xs-3 microgramma white-glow lowered spaced">BEG</div>
          <div class="col-xs-9 quicksand-reg white-glow txt-centered" id="start_time_<%= unituser.id %>"><%= unituser.start_time.in_time_zone(user.timezone).strftime('%b %e, %l:%M %p') if unituser.start_time %></div>
        </div>

        <div class="row">
          <div class="col-xs-3 microgramma white-glow lowered spaced" id="duration_<%= unituser.id %>">DUR</div>
          <div class="col-xs-9 quicksand-reg bip-duration-field white-glow txt-centered">
            <!-- #hrs_min is a method in the unit_user class - returns a formatted duration string -->
            <% if current_user == user %>
                <%= best_in_place [unit, unituser], :duration, :inner_class => "duration-input", :as => :input, :data => {:unit_duration => unit.duration}, :display_as => :duration_hrs_min %>
            <% else %>
                <%= unituser.duration_hrs_min %>
            <% end %>
          </div>
        </div>

        <div class="row">
          <div class="col-xs-3 microgramma white-glow lowered spaced">END</div>
          <div class="col-xs-9 quicksand-reg white-glow txt-centered" id="end_time_<%= unituser.id %>">       <%= unituser.end_time.in_time_zone(user.timezone).strftime('%b %e, %l:%M %p') if unituser.end_time %></div>
          <!--<div class="col-xs-9 quicksand-reg white-glow txt-centered hidden-end-times" id="end-time-hidden-<%#= unituser.id %>"><%#= unituser.end_time.in_time_zone(user.timezone)                             if unituser.end_time %></div>-->
          <div class="col-xs-9 quicksand-reg white-glow txt-centered hidden-end-times" id="end-time-hidden-<%= unituser.id %>"><%= unituser.end_time if unituser.end_time %></div>
        </div>

        <div>
          <div class="note quicksand-reg blue-glow">
            <%= best_in_place [unit, unituser], :note, :as => :textarea, :place_holder => 'note' %>
          </div>
        </div>

        <div class="txt-centered">
          <% if current_user == user %>
              <hr class="unit-user-hr"/>
              <%= link_to "delete", [unit, unituser], method: :delete, class: 'gold-glow microgramma spaced uu-delete', data: {confirm: 'Are you sure?'}, remote: true %>
          <% end %>
        </div>

      </div>
    </div>

<% end %>

<script>
    // if user changes the duration of their unit_user,
    $('.best_in_place').bind("ajax:success", function (event, data, status, xhr) {

        // target which unit_user was clicked
        var uuid = this.id.match(/\d+/)[0];
        var $unit_user_clicked = $('#unit_user_' + uuid);

        // target its parent unit
        var $unit_to_update = $unit_user_clicked.closest($('.unit'));

        // grab the whole queue of that unit
        var unit_users = JSON.parse(data)['unit_user_queue'];

        // update the end time of the unit_user
        $('#end_time_' + uuid).html(JSON.parse(data)['unit_user_end']);

        // update the unit's total duration field
        $unit_to_update.find($('.time-remaining')).html(JSON.parse(data)['unit_duration']);

        // refresh all unit_users start and end times
        for(var i=0; i<unit_users.length; i++) {
            $('#start_time_' + unit_users[i]["id"] ).html(unit_users[i]["start_time"]);
            $('#end_time_' + unit_users[i]["id"] ).html(unit_users[i]["end_time"]);
            $unit_to_update.find($('.est-time-of-completion')).html(unit_users[i]["end_time"]);
            $('#best_in_place_unit_user_' + unit_users[i]["id"] + '_duration').html(unit_users[i]["duration"]);
        }

        // wipe out old unit countdown and start a new one with the new info
        $unit_to_update.find($('.time-remaining')).countdown('destroy');
        startUnitCountdowns();

    });

</script>