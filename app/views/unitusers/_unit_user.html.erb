<!--fed by unit.html.erb-->
<!--<p>unit.id in _unit_user is <%#= unit.id %></p>-->
<!--TODO - fix best_in_place input field width, and make tabbing between inputs work correctly-->

<%= content_tag_for :li, unituser do %>

    <div class="container unit-user">

      <div class="row">
        <div class="col-xs-12 name highland-goth-bold">sdf <%= user.id %> <%= user.name.truncate(12) %> <%= unituser.id %> </div>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="col-xs-3"><%= image_tag(current_user.avatar.profile.url, :class => 'img-rounded') if current_user.avatar? %></div>
        <div class="col-xs-9">
          <div class="container">
            <div class="row">
              <div class="col-xs-10 quicksand-reg email white-glow smaller"><%= user.email.truncate(20) %></div>
            </div>
            <div class="row">
              <div class="col-xs-10 quicksand-reg email2 white-glow smaller"><%= user.email2.truncate(20) %></div>
            </div>
            <div class="row">
              <div class="col-xs-10 quicksand-reg phone white-glow smaller"><%= formatted_phone(user.phone) %></div>
            </div>
            <div class="row">
              <div class="col-xs-10 quicksand-reg phone2 white-glow smaller"><%= formatted_phone(user.phone2) %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>


        <div class="row">
          <div class="col-xs-3 highland-goth-bold white-glow-dim beg-dur-end" >BEG</div>
          <div class="col-xs-9 quicksand-reg white-glow" id="start_time_<%= unituser.id %>"><%= unituser.start_time.in_time_zone(user.timezone).strftime('%b %e, %l:%M %p') if unituser.start_time %></div>
        </div>

        <div class="row">
          <div class="col-xs-3 highland-goth-bold white-glow-dim beg-dur-end" id="duration_<%= unituser.id %>">DUR</div>
          <div class="col-xs-9 quicksand-reg bip-duration-field white-glow">
            <!-- #hrs_min is a method in the unit_user class - returns a formatted duration string -->
            <%= best_in_place [unit, unituser], :duration, :inner_class => "duration-input" , :as => :input, :data => { :unit_duration => unit.duration }, :display_as => :duration_hrs_min %>
          </div>
        </div>

        <div class="row">
          <!--<div class="col-xs-3 highland-goth-bold white-glow-dim" id="end_time_<%#= unituser.id %>">END</div>-->
          <div class="col-xs-3 highland-goth-bold white-glow-dim beg-dur-end">END</div>
          <div class="col-xs-9 quicksand-reg white-glow" id="end_time_<%= unituser.id %>"><%= unituser.end_time.in_time_zone(user.timezone).strftime('%b %e, %l:%M %p') if unituser.end_time %></div>
        </div>

        <div>
          <div class="note quicksand-reg white-glow">
            <%= best_in_place [unit, unituser], :note, :as => :textarea, :place_holder => 'click to edit' %>
          </div>
        </div>

        <div>
          <%= link_to "X", [unit,unituser], method: :delete, data: { confirm: 'Are you sure?' }, remote: true %>
        </div>

    </div>

<% end %>

<script>

    $('.best_in_place').bind("ajax:success", function (event, data, status, xhr) {
        var uuid = this.id.match(/\d+/)[0];
        var $unit_user_clicked = $('#unit_user_' + uuid);
        var unit_to_update = $unit_user_clicked.closest($('.unit'));

//        console.log(JSON.parse(data)['unit_user_end']);
        var unit_users = JSON.parse(data)['unit_user_queue'];
        console.log('unit_users is ' + unit_users);
        console.log('typeof unit_users is ' + typeof unit_users);

        // update the best_in_place duration field
        $('#best_in_place_unit_user_' + uuid + '_duration').html(JSON.parse(data)['unit_user_duration']);
        // update the unit_user's end time
        $('#end_time_' + uuid).html(JSON.parse(data)['unit_user_end']);

        // update the unit's total duration field
        unit_to_update.find($('.time-remaining')).html(JSON.parse(data)['unit_duration']);




        //    refresh all unitusers start and end times
        for (unit_user in unit_users) {
            console.dir(unit_user);
//            console.log(Object.keys(unit_user));
        };
//            $('#start_time_<%#= unit_user.id %>').html('<%#= unit_user.start_time.in_time_zone(unit_user.user.timezone).strftime('%b %e, %l:%M %p') if unit_user.start_time %>')
//            $('#end_time_<%#= unit_user.id %>').html('<%#= unit_user.end_time.in_time_zone(unit_user.user.timezone).strftime('%b %e, %l:%M %p') if unit_user.end_time %>')



    });

</script>